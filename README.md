# Agent Server

A Mastra-powered AI agent server with OAuth 2.0 authentication, dynamic agent management, RAG capabilities, and MCP integration.

## Features

- üîê **OAuth 2.0 Authentication** with JWT tokens and JWKS
- ü§ñ **Dynamic Agent Management** - Define agents, workflows, and tools in database
- üìö **RAG Database Support** - Multiple vector databases with document management
- üîå **MCP Server Integration** - Expose agents and tools via Model Context Protocol
- üóÑÔ∏è **PostgreSQL Integration** - Robust data persistence with migrations
- üß™ **Comprehensive Testing** - Unit and integration tests with Vitest
- üìä **Admin UI** - Web interface for managing all server resources

## Quick Start

### Prerequisites

- Node.js 20+
- PostgreSQL 15+
- Environment variables configured

### Installation

```bash
# Install dependencies
npm install

# Set up environment
cp .env.example .env
# Edit .env with your configuration

# Set up database
createdb agent_server_dev

# Run migrations manually
npm run migrate:up

# Start development server
npm run dev
```

## Database Management

This project uses a custom migration system instead of Prisma for optimal compatibility with Mastra's PostgreSQL library.

### Migration Philosophy

**Manual Migration Approach**: Migrations are run manually as part of the deployment process, not automatically on server startup. This ensures:

- **Predictable deployments** without startup delays
- **No race conditions** in multi-instance deployments  
- **Explicit control** over when schema changes occur
- **Better error handling** during deployment

### Migration Commands

```bash
# Run all pending migrations
npm run migrate:up

# Check migration status
npm run migrate:status

# Create new migration
npm run migrate:create add_new_feature

# Rollback last migration
npm run migrate:down

# Validate migration integrity
npm run migrate:validate
```

### Schema Overview

The system includes these main tables:
- `client_registrations` - OAuth client applications
- `agent_definitions` - Dynamic agent configurations  
- `workflow_definitions` - Dynamic workflow definitions
- `tool_definitions` - Dynamic tool implementations
- `rag_databases` - RAG vector store configurations
- `rag_documents` - Uploaded documents and metadata

See [DATABASE_MIGRATIONS.md](docs/DATABASE_MIGRATIONS.md) for detailed migration guide.

## Authentication Setup

### Generate Keys

```bash
# Generate authentication keys
npm run setup-auth
```

### Environment Variables

```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/agent_server

# Management Client (for admin operations)
MANAGEMENT_CLIENT_ID=your-admin-client-id
MANAGEMENT_CLIENT_SECRET=your-admin-secret

# JWT Authentication
MASTRA_JWT_SECRET=your-jwt-secret

# Token Service Keys (generated by setup-auth)
TOKEN_SERVICE_PRIVATE_KEY={"kty":"OKP",...}
TOKEN_SERVICE_PUBLIC_KEY={"kty":"OKP",...}
```

## API Endpoints

### Authentication
- `GET /.well-known/jwks.json` - JSON Web Key Set
- `POST /oauth/token` - Token exchange
- `POST /oauth/register` - Client registration (admin only)
- `GET /oauth/clients` - List clients (admin only)

### Agent Management
- `GET /agents` - List available agents
- `POST /agents/{id}/execute` - Execute agent
- `POST /agents/definitions` - Create agent definition (admin)
- `PUT /agents/definitions/{id}` - Update agent definition (admin)

### RAG Management
- `GET /rag/databases` - List RAG databases (admin)
- `POST /rag/databases` - Create RAG database (admin)
- `POST /rag/databases/{id}/documents` - Upload document (admin)
- `DELETE /rag/databases/{id}` - Delete RAG database (admin)

### MCP Integration
- `POST /mcp/server` - Initialize MCP server (admin)
- `GET /mcp/server` - Get MCP server info (admin)
- `POST /mcp` - MCP HTTP transport
- `GET /mcp/sse` - MCP SSE transport

## Development

### Running Tests

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run with coverage
npm run test:coverage

# Run integration tests only
npm test -- --run src/__tests__/integration
```

### Creating Migrations

```bash
# Create new migration
npm run migrate:create add_user_preferences

# Edit the generated SQL file
# Add forward migration in UP section
# Add rollback in DOWN section

# Test migration
npm run migrate:up
```

### Adding New Agents

You can add agents either in code or via the database:

#### Code-based Agent
```typescript
// src/mastra/agents/my-agent.ts
import { Agent } from '@mastra/core/agent';

export const myAgent = new Agent({
  name: 'my-agent',
  instructions: 'You are a helpful assistant',
  model: 'gpt-5',
  tools: [],
});
```

#### Database-based Agent
```typescript
// Via admin API or direct database insert
const agentDefinition = {
  name: 'dynamic-agent',
  display_name: 'Dynamic Agent',
  instructions: 'You are a dynamic agent',
  model: 'gpt-5',
  tools: ['tool1', 'tool2'],
  scopes: ['agent.execute'],
  is_active: true
};
```

## Architecture

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) for detailed system architecture.

### Key Components

- **Mastra Core** - Agent framework and workflow engine
- **PostgreSQL Store** - Data persistence layer
- **JWT Auth** - Token-based authentication
- **Dynamic Loader** - Database-driven resource loading
- **RAG Service** - Vector database management
- **MCP Server** - Model Context Protocol integration

## Production Deployment

### Environment Setup

```bash
# Production database
DATABASE_URL=postgresql://prod_user:prod_pass@prod_host:5432/agent_server_prod

# Run migrations manually before starting the server
NODE_ENV=production npm run migrate:up

# Build and start
npm run build
npm start
```

### Vercel Deployment

The project includes Vercel configuration:

```json
// vercel.json
{
  "functions": {
    "src/mastra/index.ts": {
      "runtime": "nodejs20.x"
    }
  },
  "routes": [
    { "src": "/(.*)", "dest": "/src/mastra/index.ts" }
  ]
}
```

### Security Considerations

- Use strong secrets in production
- Enable SSL/TLS for database connections
- Rotate JWT secrets regularly
- Implement rate limiting
- Monitor authentication failures
- Regularly backup database

## Contributing

1. Fork the repository
2. Create feature branch
3. Add tests for new functionality  
4. Ensure all tests pass
5. Update documentation
6. Submit pull request

### Code Style

- Use TypeScript for all new code
- Follow existing patterns
- Add JSDoc comments for public APIs
- Write tests for new features
- Update migration files for schema changes

## Troubleshooting

### Common Issues

#### Database Connection
```bash
# Test connection
psql $DATABASE_URL -c "SELECT 1;"

# Check if migrations table exists
psql $DATABASE_URL -c "SELECT * FROM schema_migrations;"
```

#### Migration Issues
```bash
# Check migration status
npm run migrate:status

# Validate migration integrity
npm run migrate:validate

# Reset development database
dropdb agent_server_dev && createdb agent_server_dev
npm run migrate:up
```

#### Authentication Issues
```bash
# Regenerate keys
npm run setup-auth

# Test token endpoint
curl -X POST http://localhost:3000/oauth/token \
  -H "Content-Type: application/json" \
  -d '{"grant_type":"client_credentials","client_id":"test","client_secret":"test"}'
```

#### Schema/Table Missing Issues
```bash
# If you get "table does not exist" errors, run migrations
npm run migrate:up

# Check what migrations have been applied
npm run migrate:status

# Validate schema integrity
npm run migrate:validate
```

## Documentation

- [Architecture Overview](docs/ARCHITECTURE.md)
- [Database Migrations](docs/DATABASE_MIGRATIONS.md)
- [Testing Guide](docs/TESTING.md)
- [Current Implementation Status](docs/CURRENT_STATE.md)
- [Implementation Plan](docs/IMPLEMENTATION_PLAN.md)

## License

MIT License - see LICENSE file for details.
