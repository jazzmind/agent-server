# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Core Development
```bash
# Install dependencies
npm install

# Run development server (Mastra)
npm run dev

# Build for production
npm run build

# Start production server
npm start
```

### Testing
```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests with coverage
npm run test:coverage

# Run specific test file
npm test -- src/__tests__/auth/auth-routes.test.ts

# Run integration tests only
npm test -- --run src/__tests__/integration
```

### Database Management
```bash
# Run all pending migrations (required before server start)
npm run migrate:up

# Check migration status
npm run migrate:status

# Create new migration
npm run migrate:create <migration_name>

# Rollback last migration
npm run migrate:down

# Validate migration integrity
npm run migrate:validate

# Seed database with sample data
npm run seed
```

### Authentication Setup
```bash
# Generate authentication keys (required for first-time setup)
npm run setup-auth
```

## Architecture Overview

### Core Framework
The server is built on **Mastra**, a framework for building AI agent systems. The main entry point is `src/mastra/index.ts` which initializes:
- Dynamic agent/tool/workflow loading from PostgreSQL
- OAuth 2.0 authentication with JWT tokens
- Middleware for request handling and authentication

### Authentication System
Located in `src/mastra/auth/`, the authentication system implements OAuth 2.0 client credentials flow with:
- Management client for admin operations (credentials from environment variables)
- PostgreSQL-backed client storage in `client_registrations` table
- Scope-based authorization (e.g., `admin.read`, `agent.execute`)
- JWT token generation with Ed25519 keys

### Dynamic Loading System
The `DynamicLoader` service (`src/mastra/services/dynamic-loader.ts`) enables runtime loading of:
- **Agents**: AI agents defined in `agent_definitions` table
- **Tools**: Executable functions in `tool_definitions` table
- **Workflows**: Multi-step processes in `workflow_definitions` table
- **Scorers**: Evaluation functions in `scorer_definitions` table
- **Networks**: Integration networks in `network_definitions` table

All definitions are loaded from PostgreSQL and merged with hardcoded implementations.

### Database Layer
Uses PostgreSQL with custom migration system (`src/db/migrations/`):
- Migration files in `src/db/migrations/sql/` with UP/DOWN sections
- Schema includes tables for clients, agents, workflows, tools, RAG databases, and documents
- Migrations must be run manually before deployment (not auto-run on startup)

### Testing Strategy
Tests use Vitest with:
- Unit tests for individual components
- Integration tests for end-to-end flows
- Mock implementations for PostgreSQL and external services
- Setup file at `src/__tests__/setup.ts` for test environment configuration

## Environment Configuration

Required environment variables:
```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/agent_server

# Management Client (for admin operations)
MANAGEMENT_CLIENT_ID=your-admin-client-id
MANAGEMENT_CLIENT_SECRET=your-admin-secret

# JWT Authentication
MASTRA_JWT_SECRET=your-jwt-secret

# Token Service Keys (generated by setup-auth)
TOKEN_SERVICE_PRIVATE_KEY={"kty":"OKP",...}
TOKEN_SERVICE_PUBLIC_KEY={"kty":"OKP",...}
```

## Key Implementation Patterns

### Adding New Agents
Agents can be added either in code (`src/mastra/agents/`) or via database:
- Code agents: Create new Agent instance with name, instructions, model, and tools
- Database agents: Insert into `agent_definitions` table with same properties plus scopes

### Error Handling
- All routes use try-catch with detailed error logging
- Database operations include fallback to memory storage
- Authentication failures return appropriate HTTP status codes

### Middleware Structure
Middleware stack in `src/mastra/index.ts`:
1. Request logging
2. Authentication verification for `/api/*` routes
3. Admin permission checks via `verifyAdminBearerToken`

## TypeScript Configuration

- Target: ES2022
- Module: ESNext with Node resolution
- Strict mode enabled
- Source in `src/`, output to `dist/`
- Test files excluded from compilation